# ずんだもんモード - 要件定義書

## 概要
ユーザーの操作に対して、N%の確率でAIアシスタントの応答が「ずんだもん」風の特徴的な語尾や表現に変換される機能を実装します。

## 背景
- Claude Codeの応答をより親しみやすくユーザーフレンドリーにしたい
- 長時間の作業中に、時々異なる応答パターンがあることで作業の単調さを軽減
- ずんだもんというキャラクターの人気と親しみやすさを活用
- 既存のUserPromptSubmitフックに新しい条件タイプを追加することで実現

## 要求仕様

### 機能要件

#### 1. random_chance 条件タイプ
- UserPromptSubmitイベントで使用可能な新しい条件タイプ
- 0から100の整数値で確率をパーセント指定
- 各プロンプト送信時に独立して確率判定を実行
- 乱数生成は暗号学的に安全である必要はなく、一般的な擬似乱数で十分

#### 2. ずんだもん風メッセージ変換
- 通常の応答の後に、ずんだもん風の語尾や表現を追加
- 変換パターンの例：
  - 語尾に「なのだ」「のだ」を追加
  - 「〜です」→「〜なのだ」
  - 「〜ます」→「〜するのだ」
  - 「〜ました」→「〜したのだ」
  - 感嘆表現に「ずんだ！」を追加
  - 質問文には「〜のだ？」を使用

#### 3. 設定例
```yaml
UserPromptSubmit:
  # 10%の確率でずんだもんモード
  - conditions:
      - type: random_chance
        value: "10"
    actions:
      - type: output
        message: "ずんだもんモードが発動したのだ！今回の応答はずんだもん風になるのだ！"

  # 複数の確率設定も可能
  - conditions:
      - type: random_chance
        value: "5"
    actions:
      - type: output
        message: "【レアモード】めずらしいずんだもんが出現したのだ！ずんだー！"
  
  # 他の条件と組み合わせ
  - conditions:
      - type: prompt_regex
        value: "テスト|test"
      - type: random_chance
        value: "30"
    actions:
      - type: output
        message: "テスト関連の作業で30%の確率でずんだもんが応援するのだ！がんばるのだ！"
```

### 非機能要件

#### パフォーマンス
- 乱数生成は高速で、応答遅延を発生させない
- 確率判定は各リクエストで独立して実行される
- 乱数シードは適切に初期化される（プログラム起動時に1回）

#### テスタビリティ
- 乱数生成部分はモック可能な設計
- 単体テストで確率判定のロジックを検証可能
- 統合テストで実際の動作を確認可能

#### 保守性
- random_chance条件は他の確率ベースの機能でも再利用可能
- 既存のコードアーキテクチャに従って実装
- 適切なエラーハンドリング（無効な確率値の検出など）

## 使用シーン

### シーン1: 通常の開発作業
ユーザーがコードの修正を依頼：
```
User: "このバグを修正して"
```

10%の確率で発動した場合：
```
Assistant: "ずんだもんモードが発動したのだ！今回の応答はずんだもん風になるのだ！"
Assistant: "バグを修正するのだ！このコードに問題があるみたいなのだ..."
```

### シーン2: テスト実行
ユーザーがテスト実行を依頼：
```
User: "テストを実行して"
```

30%の確率で発動した場合（テスト関連キーワード検出）：
```
Assistant: "テスト関連の作業で30%の確率でずんだもんが応援するのだ！がんばるのだ！"
Assistant: "テストを実行するのだ！全部グリーンになるといいのだ..."
```

### シーン3: 長時間作業中の息抜き
連続した作業中に、時々ずんだもんモードが発動することで、作業の単調さを軽減：
```
User: "次の機能も実装して"
```

5%の確率でレアモード発動：
```
Assistant: "【レアモード】めずらしいずんだもんが出現したのだ！ずんだー！"
Assistant: "特別なずんだもんパワーで機能を実装するのだ！今日はいいことがありそうなのだ！"
```

## 制約事項

### 技術的制約
- Go言語の標準ライブラリ（math/rand）を使用
- 既存のUserPromptSubmitイベント処理フローに統合
- 既存の条件タイプの命名規則と実装パターンに従う

### ビジネス制約
- プロフェッショナルな用途でも使用可能なよう、確率を低く設定可能（0%設定で無効化）
- メッセージは日本語のみ対応（将来的に他言語対応の可能性）
- ずんだもんの表現は一般的に知られている範囲内で実装

### 実装上の考慮事項
- 確率値は0-100の整数のみ受け付ける
- 無効な値（負の数、100を超える値、数値以外）はエラーとして処理
- 乱数シードの初期化はプログラムの起動時に一度だけ実行
- 複数のrandom_chance条件が設定されている場合、それぞれ独立して判定

## 成功基準

1. **機能の完成度**
   - random_chance条件タイプが正しく動作する
   - 指定された確率で条件が成立する
   - 他の条件タイプと組み合わせて使用できる

2. **品質基準**
   - 単体テストのカバレッジ80%以上
   - 統合テストで実際の動作を確認
   - エラーハンドリングが適切に実装されている

3. **ユーザビリティ**
   - 設定が直感的で分かりやすい
   - ドキュメントが充実している
   - 設定例が豊富に提供されている

## リスクと対策

### リスク1: 確率の偏り
- **リスク**: 乱数生成に偏りがあり、期待通りの確率で発動しない
- **対策**: 適切な乱数シードの初期化と、統計的なテストの実施

### リスク2: パフォーマンスへの影響
- **リスク**: 全てのUserPromptSubmitイベントで乱数生成を行うことによる遅延
- **対策**: Go言語の効率的な乱数生成を使用、必要に応じてキャッシング

### リスク3: ユーザーの混乱
- **リスク**: 突然のずんだもんモードにユーザーが困惑する
- **対策**: 明確なメッセージでモード発動を通知、適切なデフォルト確率の設定

## 今後の拡張可能性

1. **他のキャラクターモード**
   - 同様の仕組みで他のキャラクター風の応答も実装可能

2. **確率の動的変更**
   - 時間帯や作業内容によって確率を変動させる機能

3. **ユーザーごとの設定**
   - session_idベースで異なる確率設定を適用

4. **統計情報の収集**
   - ずんだもんモードの発動回数やユーザーの反応を記録

## 受け入れテスト

1. **基本動作テスト**
   - random_chance: "10" で設定し、100回実行して約10回発動することを確認

2. **境界値テスト**
   - random_chance: "0" で一度も発動しないことを確認
   - random_chance: "100" で必ず発動することを確認

3. **組み合わせテスト**
   - prompt_regexとrandom_chanceを組み合わせて正しく動作することを確認

4. **エラー処理テスト**
   - random_chance: "-1"、"101"、"abc" などの無効値でエラーが発生することを確認

## 用語集

- **ずんだもん**: 東北地方のずんだ餅をモチーフにしたキャラクター
- **random_chance**: ランダムな確率で条件を成立させる新しい条件タイプ
- **UserPromptSubmit**: ユーザーがプロンプトを送信した際に発火するイベント
- **条件タイプ**: cchookで使用される条件判定の種類